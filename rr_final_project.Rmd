---
title: "Health & Economic Consequences of Extreme Weather Events"
author: "C. McBride"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Synopsis

This report explores the U.S. National Oceanic and Atmospheric Administration's (NOAA) storm dataset, which tracks extreme weather events in the United States, including estimates of any fatalities, injuries, and property damage. These features will be focus of this report as events are ranked by the damage and casualties they inflict. The data themselves required extensive cleaning and reformatting. Most importantly the wide-ranging weather event types were gathered into general categories based on similar characteristics such as temperature, percipitation or variations in naming. The result were more interpretable data that I think supported more meaningful responses to the assignment questions.


## Data Processing & Exploratory Analysis

```{r Get Packages, message=FALSE, warning=FALSE}
# load packages
library(dplyr)
library(ggplot2)
library(gtable)
library(knitr)
library(lubridate)
library(maps)
library(readr)
library(reshape2)
library(scales)
library(stringi)
```


```{r Load Data, message=FALSE, warning=FALSE}
# load compressed data as tibble
noaa <- read_csv("noaa_extreme_weather.csv.bz2")
```

After cataloging the multitude of weather event types, it seemed advisable not only to clean up that many disparities in the data but also gather the data into categories so that similar events could be examined and assessed collectively. Event types that were infrequent or didn't fit within the defined broader categories were eliminated; a threshold of 500 events per category or type was set.

```{r Clean Data, message=FALSE, warning=FALSE}
## clean `EVTYPE` data
# format all levels to uppercase (reduces unique levels by almost 100)
noaa[, "EVTYPE"] <- toupper(noaa$EVTYPE)

# remove summary categories, create dataframe copy
noaa_clean <- noaa[!(stri_detect_regex(noaa$EVTYPE, "SUMMARY")),]

## simplify categories
# find and rename all extreme winter weather events (except snow) under one name
cold <- stri_detect_regex(as.character(noaa_clean$EVTYPE), 
                          "(BLIZZARD|WINT|FREEZE|COLD|ICE|SLEET|ICY)")
noaa_clean[cold, "EVCAT"] <- "COLD"; rm(cold)

# gather all variations of names for hail events under one level name
hail <- stri_detect_regex(as.character(noaa_clean$EVTYPE), "HAIL")
noaa_clean[hail, "EVCAT"] <- "HAIL"; rm(hail)

# all flood related extreme weather events under one level name
flood <- stri_detect_regex(as.character(noaa_clean$EVTYPE),
                           "(FLOOD|TSUNAMI|FLD|HIGH TIDE|SURF|SEICHE)")
noaa_clean[flood, "EVCAT"] <- "FLOOD"; rm(flood)

# all major oceanic storms under one level name
hurricane <- stri_detect_regex(as.character(noaa_clean$EVTYPE),
                               "(HURRICANE|TYPHOON|TROPICAL|SURGE)")
noaa_clean[hurricane, "EVCAT"] <- "HURRICANE"; rm(hurricane)

# all thunderstorm and extreme rain under one level name
tstorm <- stri_detect_regex(as.character(noaa_clean$EVTYPE), 
                            "(THUN| TSTM|RAIN|PRECIP)")
noaa_clean[tstorm, "EVCAT"] <- "THUNDERSTORM"; rm(tstorm)

# all extreme heat and drought events under one name
heat_dry <- stri_detect_regex(as.character(noaa_clean$EVTYPE), 
                              "(DROUGHT|DRY|HOT|WARM|HEAT)")
noaa_clean[heat_dry, "EVCAT"] <- "HEAT_DRY"; rm(heat_dry)

# all tornado type events under one level name
tornado <- stri_detect_regex(as.character(noaa_clean$EVTYPE), 
             ("TORNAD|SPOUT|WHIRL|FUNNEL|ROTATING WALL CLOUD|DUST DEVIL"))
noaa_clean[tornado, "EVCAT"] <- "TORNADO"; rm(tornado)

# all extreme wind events (except tornadoes) under one level name
wind <- stri_detect_regex(as.character(noaa_clean$EVTYPE), 
                          "(WIND|BURST|WHIRL)")
noaa_clean[wind, "EVCAT"] <- "WIND"; rm(wind)

# all variations of snow under one level name
snow <- stri_detect_regex(as.character(noaa_clean$EVTYPE), "SNOW")
noaa_clean[snow, "EVCAT"] <- "SNOW"; rm(snow)

# all variations of wildfire descriptions under one level name
fire <- stri_detect_regex(as.character(noaa_clean$EVTYPE), "(FIRE|SMOKE)")
noaa_clean[fire, "EVCAT"] <- "FIRE"; rm(fire)

# all variations of volcano under one level name
volcano <- stri_detect_regex(as.character(noaa_clean$EVTYPE), "VOLCA")
noaa_clean[volcano, "EVCAT"] <- "VOLCANO"; rm(volcano)

# all variations of volcano under one level name
fog<- stri_detect_regex(as.character(noaa_clean$EVTYPE), "FOG")
noaa_clean[fog, "EVCAT"] <- "FOG"; rm(fog)
```

```{r}
# remove event types with small counts
nas <- is.na(noaa_clean$EVCAT)
noaa_clean$EVCAT[nas] <- noaa_clean$EVTYPE[nas]


freq_evts <- table(noaa_clean$EVCAT)[table(noaa_clean$EVCAT) > 500]
noaa_clean <- noaa_clean[noaa_clean$EVCAT %in% names(freq_evts),]

# changes to feature classes
noaa_clean[, "EVCAT"] <- as.factor(noaa_clean$EVCAT)
```

Next, the data was grouped by category, and counts for fatalities and injuries were calculated. 


```{r}
smry_fatals <- noaa_clean%>%
  group_by(EVCAT)%>%
  summarize(tot_fatals=sum(FATALITIES),
            tot_injuries=sum(INJURIES))%>%
  melt(id.vars='EVCAT', measure.vars=c('tot_fatals', 
                                       'tot_injuries'),
       variable.name="type", value.name = "value")%>%
  arrange(type, desc(value))

smry_fatals$EVCAT <- factor(smry_fatals$EVCAT, 
                            levels=smry_fatals$EVCAT[14:26])
```

```{r}
ggplot(smry_fatals)+
  geom_bar(aes(x=EVCAT, y=log(value), fill=type), 
           stat="identity", show.legend = FALSE)+
  facet_wrap(~type, nrow=3, scales = "free_y", strip.position = "right",
             labeller = as_labeller(c(
                                      'tot_fatals'="Fatalities",
                                      'tot_injuries'="Injuries")
                                    ))+
  labs(title="Casualties by Event Category", 
       y="Number of Casualties (log scale)")+
  theme(axis.text.x = element_text(hjust=1, angle=75),
        axis.title.x = element_blank(),
        plot.title = element_text(hjust=0.5))

```

After producing the summary of the casualties data, the analysis moved on to look at the cost in property damage caused by each event category. As a preliminary formatting step the existing base damage estimate was combined with its exponent counterpart to get an integer estimate of the damages caused by each event. At this point, anomalous values were removed from the dataset.

```{r}
## Calculate damages with PROPDMG and CROPDMG with their exponent variables
# deal with NA's in exponent columns
noaa_clean[is.na(noaa_clean$PROPDMGEXP), 'PROPDMGEXP'] <- "0"
noaa_clean[is.na(noaa_clean$CROPDMGEXP), 'CROPDMGEXP'] <- "0"

# Set up look-up list for transforming exponent variable to numerical
dmg_exps <- list("K"=3, "M"=6, "B"=9, "m"=6, "h"=2, "H"=2, "k"=3)

# Deal with anomalous characters in PROPDMGEXP and CROPDMGEXP
noaa_clean[noaa_clean$PROPDMGEXP %in% c("+", "?", "-"),
           'PROPDMGEXP'] <- "0"
noaa_clean[noaa_clean$CROPDMGEXP %in% c("+", "?", "-"),
           'CROPDMGEXP'] <- "0"

# Transform letter exponent to number
noaa_clean$PROPDMGEXP <- sapply(noaa_clean$PROPDMGEXP,
                                function(e){
                                  ifelse(e %in% names(dmg_exps), 
                                         dmg_exps[[e]], as.numeric(e))
                                })

noaa_clean$CROPDMGEXP <- sapply(noaa_clean$CROPDMGEXP,
                                function(e){
                                  ifelse(e %in% names(dmg_exps), 
                                         dmg_exps[[e]], as.numeric(e))
                                })
# Perform exponent calculations, assign full cost value back to PROPDMG, CROPDMG
noaa_clean <- noaa_clean%>%
  mutate(PROPDMG_TOT=PROPDMG*10^PROPDMGEXP,
         CROPDMG_TOT=CROPDMG*10^CROPDMGEXP,
         YEAR=year(as.Date(BGN_DATE, format="%m/%d/%Y")))
```

```{r}
# Group data by event category and year, summarize by property and crop totals
smry_dmgs <- noaa_clean%>%
  group_by(EVCAT, YEAR)%>%
  summarize(tot_prop=mean(PROPDMG_TOT),
            tot_crop=mean(CROPDMG_TOT))%>%
  filter(tot_prop > 0 & tot_crop > 0)%>%
  melt(id.vars=c('EVCAT', 'YEAR'), measure.vars=c('tot_prop', 'tot_crop'),
       variable.name="type", value.name = "value")%>%
  arrange(type, desc(value))

```


```{r error=FALSE, message=FALSE, warning=FALSE}
# Time series line plot of property damages facet by category
ggplot(subset(smry_dmgs, type=="tot_prop"), aes(x=YEAR, y=log(value)))+
  geom_line(stat="identity", show.legend = FALSE)+
  labs(title="Mean Property Damage Trends by Year and Event Category",
       y="Dollars (log scale)")+
  facet_wrap(~EVCAT, ncol=3, scales="fixed")+
  theme(panel.background = element_blank(),
        plot.title = element_text(hjust=0.5),
        axis.text.x = element_text(hjust = 1, angle = 75),
        axis.title.x = element_blank(),
        panel.grid.major = element_line(color="grey95"))
```

```{r}
smry_dmgs <- smry_dmgs%>%
  arrange(type, value)

ggplot(subset(smry_dmgs, type=="tot_prop"), 
       aes(x=EVCAT, y=log(value)))+
  geom_bar(stat = "sum")+
  theme(axis.text.x = element_text(hjust=1, angle = 75))
```



```{r}
## Prepare geographic plot
# correct coordinate format
# format longitude values
frmt_lons <- function(x){ 
  x2 <- x%/%100 + x%%100/100
  if(x2<0){
    return(x2)
  }else{
    return(x2*-1)
  }
}

# format latitude values
frmt_lats <- function(x){ 
  x%/%100 + x%%100/100
}

# Apply functions for coordinal data
noaa_clean$LONGITUDE <- sapply(noaa_clean$LONGITUDE, frmt_lons) 
noaa_clean$LATITUDE <- sapply(noaa_clean$LATITUDE, frmt_lats)

# Further subset coordinate values against bounding box of continental US
noaa_map_data <- subset(noaa_clean, (LATITUDE > 24.30 & LATITUDE < 49.40) & 
                                    (LONGITUDE > -124.90 & LONGITUDE < -66.80))
```

```{r}
# Get base map
bs_map <- map_data("state")

# Subset for extreme events in terms of damages
noaa_map_data <- subset(noaa_map_data, 
                        PROPDMG_TOT > quantile(noaa_map_data$PROPDMG_TOT, 0.95) &
                        YEAR >= 2000 &
                        EVCAT %in% c('FLOOD', 'THUNDERSTORM', 'TORNADO', 'HAIL'))

# Plot map
ggplot()+
  geom_polygon(data=bs_map, aes(x=long, y=lat, group=group), 
               fill="grey85", color="black")+
  # Plot individual events
  geom_point(data=noaa_map_data, aes(x=LONGITUDE, y=LATITUDE, color=EVCAT),
             alpha=0.2, show.legend = FALSE)+
  labs(title="Geographical Distribution of Costliest Events",
       subtitle="(95% Quantile by Damage Costs Since 2000)")+
  facet_wrap(~EVCAT, ncol=2)+
  theme(panel.background=element_blank(),
        axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        plot.title = element_text(hjust=0.5),
        plot.subtitle = element_text(hjust=0.5))
```



## Main Analysis


## Results & Conclusions




## Citations & Links


