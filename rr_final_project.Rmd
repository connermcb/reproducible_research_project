---
title: "Health & Economic Outcomes of Severe Weather Events"
author: "C. McBride"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Synopsis

This report explores the U.S. National Oceanic and Atmospheric Administration's (NOAA) storm dataset, which tracks extreme weather events in the United States, including estimates of any fatalities, injuries, and property damage. These features will be the focus of this report by ranking categories of sever weather events by their consequent material damage and human casualties. 

The data themselves required extensive cleaning and reformatting. Most importantly, the wide-ranging weather event types were gathered into general categories based on similar characteristics such as temperature, percipitation type, storm variety or variations in event naming. The result were more interpretable data that I think supported more meaningful responses to the assignment questions.

While all event categories registered significant and impacts, the events that caused the greatest loss in both terms of life and property were hurricanes, tornados and flooding.


## Data Processing & Exploratory Analysis

__Step 1:__ The requisite libraries are loaded to facilitate analysis and data munging. 

```{r Get Packages, message=FALSE, warning=FALSE}
# load packages
library(dplyr)
library(ggplot2)
library(gtable)
library(knitr)
library(lubridate)
library(maps)
library(readr)
library(reshape2)
library(scales)
library(stringi)
```

__Step 2:__ The dataset is loaded into the working environment and all possible values of `EVTYPE` are catalogued.

```{r Load Data, message=FALSE, warning=FALSE}
# load compressed data as tibble
noaa <- read_csv("noaa_extreme_weather.csv.bz2")

# get domain of severe weather events
unq <- unique(noaa$EVTYPE)
length(unq)
head(unq)
```

__Step 3:__ After informally cataloging the multitude of weather event types (using `table(noaa$EVTYPE)`), it seemed advisable not only to clean up the many errors and disparities in the data but also gather the data into categories so that similar events could be examined and assessed collectively. The reasoning here was that similar events often develop under similar conditions and share a profile in terms of damages. 

```{r Clean Data, message=FALSE, warning=FALSE}
## clean `EVTYPE` data
# format all levels to uppercase (reduces unique levels by almost 100)
noaa[, "EVTYPE"] <- toupper(noaa$EVTYPE)

# remove summary categories, create dataframe copy
noaa_clean <- noaa[!(stri_detect_regex(noaa$EVTYPE, "SUMMARY")),]

## simplify categories
# find and rename all extreme winter weather events (except snow) under one name
cold <- stri_detect_regex(as.character(noaa_clean$EVTYPE), 
                          "(BLIZZARD|WINT|FREEZE|COLD|ICE|SLEET|ICY)")
noaa_clean[cold, "EVCAT"] <- "COLD"; rm(cold)

# gather all variations of names for hail events under one level name
hail <- stri_detect_regex(as.character(noaa_clean$EVTYPE), "HAIL")
noaa_clean[hail, "EVCAT"] <- "HAIL"; rm(hail)

# all flood related extreme weather events under one level name
flood <- stri_detect_regex(as.character(noaa_clean$EVTYPE),
                           "(FLOOD|TSUNAMI|FLD|HIGH TIDE|SURF|SEICHE)")
noaa_clean[flood, "EVCAT"] <- "FLOOD"; rm(flood)

# all major oceanic storms under one level name
hurricane <- stri_detect_regex(as.character(noaa_clean$EVTYPE),
                               "(HURRICANE|TYPHOON|TROPICAL|SURGE)")
noaa_clean[hurricane, "EVCAT"] <- "HURRICANE"; rm(hurricane)

# all thunderstorm and extreme rain under one level name
tstorm <- stri_detect_regex(as.character(noaa_clean$EVTYPE), 
                            "(THUN| TSTM|RAIN|PRECIP)")
noaa_clean[tstorm, "EVCAT"] <- "THUNDERSTORM"; rm(tstorm)

# all extreme heat and drought events under one name
heat_dry <- stri_detect_regex(as.character(noaa_clean$EVTYPE), 
                              "(DROUGHT|DRY|HOT|WARM|HEAT)")
noaa_clean[heat_dry, "EVCAT"] <- "HEAT_DRY"; rm(heat_dry)

# all tornado type events under one level name
tornado <- stri_detect_regex(as.character(noaa_clean$EVTYPE), 
             ("TORNAD|SPOUT|WHIRL|FUNNEL|ROTATING WALL CLOUD|DUST DEVIL"))
noaa_clean[tornado, "EVCAT"] <- "TORNADO"; rm(tornado)

# all extreme wind events (except tornadoes) under one level name
wind <- stri_detect_regex(as.character(noaa_clean$EVTYPE), 
                          "(WIND|BURST|WHIRL)")
noaa_clean[wind, "EVCAT"] <- "WIND"; rm(wind)

# all variations of snow under one level name
snow <- stri_detect_regex(as.character(noaa_clean$EVTYPE), "SNOW")
noaa_clean[snow, "EVCAT"] <- "SNOW"; rm(snow)

# all variations of wildfire descriptions under one level name
fire <- stri_detect_regex(as.character(noaa_clean$EVTYPE), "(FIRE|SMOKE)")
noaa_clean[fire, "EVCAT"] <- "FIRE"; rm(fire)

# all variations of volcano under one level name
volcano <- stri_detect_regex(as.character(noaa_clean$EVTYPE), "VOLCA")
noaa_clean[volcano, "EVCAT"] <- "VOLCANO"; rm(volcano)

# all variations of volcano under one level name
fog<- stri_detect_regex(as.character(noaa_clean$EVTYPE), "FOG")
noaa_clean[fog, "EVCAT"] <- "FOG"; rm(fog)
```

__Step 4:__ Event types that were infrequent or didn't fit within the defined broader categories were eliminated, and event types and categories that were infrequently represented (n < 500) over the whole timespan of the data were not included.

```{r}
# assign EVTYPE value to EVCAT for those event types that weren't grouped under
# a larger category in previous step
nas <- is.na(noaa_clean$EVCAT)
noaa_clean$EVCAT[nas] <- noaa_clean$EVTYPE[nas]

# remove most infrequent categories
freq_evts <- table(noaa_clean$EVCAT)[table(noaa_clean$EVCAT) > 500]
noaa_clean <- noaa_clean[noaa_clean$EVCAT %in% names(freq_evts),]

# changes to feature classes
noaa_clean[, "EVCAT"] <- as.factor(noaa_clean$EVCAT)
```

__Step 5:__ Next, the data was grouped by category, and counts for fatalities and injuries were calculated. 

```{r}
# group data by EVCAT and get total fatalities, injuries for each category
smry_fatals <- noaa_clean%>%
  group_by(EVCAT)%>%
  summarize(tot_fatals=sum(FATALITIES),
            tot_injuries=sum(INJURIES))%>%
  melt(id.vars='EVCAT', measure.vars=c('tot_fatals', 
                                       'tot_injuries'),
       variable.name="type", value.name = "value")%>%
  arrange(type, desc(value))

# Change levle order in prep for sorted bar plot
smry_fatals$EVCAT <- factor(smry_fatals$EVCAT, 
                            levels=smry_fatals$EVCAT[14:26])
```

__Step 6:__ Using the grouped and summarized data, a bar plot is made comparing the two classes of casualties by event category.

```{r}

```

__Step 7:__ After producing the summary of the casualties data, the analysis moved on to look at the cost in property damage caused by each event category. As a preliminary formatting step the existing base damage estimate was combined with its exponent counterpart to get an integer estimate of the damages caused by each event. At this point, anomalous values were removed from the dataset.

```{r}
## Calculate damages with PROPDMG and CROPDMG with their exponent variables
# deal with NA's in exponent columns
noaa_clean[is.na(noaa_clean$PROPDMGEXP), 'PROPDMGEXP'] <- "0"
noaa_clean[is.na(noaa_clean$CROPDMGEXP), 'CROPDMGEXP'] <- "0"

# Set up look-up list for transforming exponent variable to numerical
dmg_exps <- list("K"=3, "M"=6, "B"=9, "m"=6, "h"=2, "H"=2, "k"=3)

# Deal with anomalous characters in PROPDMGEXP and CROPDMGEXP
noaa_clean[noaa_clean$PROPDMGEXP %in% c("+", "?", "-"),
           'PROPDMGEXP'] <- "0"
noaa_clean[noaa_clean$CROPDMGEXP %in% c("+", "?", "-"),
           'CROPDMGEXP'] <- "0"

# Transform letter exponent to number
noaa_clean$PROPDMGEXP <- sapply(noaa_clean$PROPDMGEXP,
                                function(e){
                                  ifelse(e %in% names(dmg_exps), 
                                         dmg_exps[[e]], as.numeric(e))
                                })

noaa_clean$CROPDMGEXP <- sapply(noaa_clean$CROPDMGEXP,
                                function(e){
                                  ifelse(e %in% names(dmg_exps), 
                                         dmg_exps[[e]], as.numeric(e))
                                })
# Perform exponent calculations, assign full cost value back to PROPDMG, CROPDMG
noaa_clean <- noaa_clean%>%
  mutate(PROPDMG_TOT=PROPDMG*10^PROPDMGEXP,
         CROPDMG_TOT=CROPDMG*10^CROPDMGEXP,
         YEAR=year(as.Date(BGN_DATE, format="%m/%d/%Y")))
```


__Step 8:__ A quick summary to test for outliers.

```{r}
noaa_clean%>%
  group_by(EVCAT)%>%
  summarize(
            mean=mean(PROPDMG_TOT),
            median=median(PROPDMG_TOT),
            third_qrt=quantile(PROPDMG_TOT, .75), 
            max=max(PROPDMG_TOT))

```

Most of the max values deserve some attention event category by category. In the case of `COLD`, the max value for `PROPDMG_TOT` of $5 billion doesn't seem impossible since the event in question was described as the ["Storm of the Century" or the "Blizzard of 1993"][1] in popular culture and categorized as a category 5 storm meteorologically. 

The costliest fire likewise turns out not to be a data error. The [Cerro Grande Fire][2] in northern New Mexico along with other fires across the state caused widespread damage worth over a billion dollars.

The damages caused by a severe hail storm in October of 2010 in Phoenix, Arizona caused close to $2 billion in damages.

The maximum value for `THUNDERSTORM` is probably better moved to the flood category. 

The billion dollar damages recorded for the top tornado belonged to a tornado that tore through Joplin, Missouri.

The maximimum value for `WIND` is actually another instance, albeit geographically unique, for the ["Storm of the Century"][1]. Many of the other extreme property damages value for this category are attributalbe to hurricanes.

__Step 9:__ Next, the same grouping and summarizing is performed on the data this time grouping the data by EVCAT and YEAR and getting the mean property and crop damage.

```{r}
# Group data by event category and year, summarize by property and crop totals
smry_dmgs <- noaa_clean%>%
  group_by(EVCAT, YEAR)%>%
  summarize(tot_prop=mean(PROPDMG_TOT),
            tot_crop=mean(CROPDMG_TOT))%>%
  filter(tot_prop > 0 & tot_crop > 0)%>%
  melt(id.vars=c('EVCAT', 'YEAR'), measure.vars=c('tot_prop', 'tot_crop'),
       variable.name="type", value.name = "value")%>%
  arrange(type, desc(value))

```
 
__Step 10:__ 

```{r error=FALSE, message=FALSE, warning=FALSE}

```

__Step 11:__ To prepare for a plot in geographical space, the coordinate values were cleaned and formatted. Although the data includes events from US territories and the two states outside the contiguous US, the data was further subsetted on the lower 48 states. 

```{r}
## Prepare geographic plot
# correct coordinate format
# format longitude values
frmt_lons <- function(x){ 
  x2 <- x%/%100 + x%%100/100
  if(x2<0){
    return(x2)
  }else{
    return(x2*-1)
  }
}

# format latitude values
frmt_lats <- function(x){ 
  x%/%100 + x%%100/100
}

# Apply functions for coordinal data
noaa_clean$LONGITUDE <- sapply(noaa_clean$LONGITUDE, frmt_lons) 
noaa_clean$LATITUDE <- sapply(noaa_clean$LATITUDE, frmt_lats)

# Further subset coordinate values against bounding box of continental US
noaa_map_data <- subset(noaa_clean, (LATITUDE > 24.30 & LATITUDE < 49.40) & 
                                    (LONGITUDE > -124.90 & LONGITUDE < -66.80))
```

__Step 12:__ 

```{r}

```


## Results & Conclusions

The first research question was answered visually by plotting the aggregate casualty figures per generated category. The values for the most deadly weather categories so exaggerated the y-axis that a log-scale was used so that the bars for the other categries would be apparent. The most deadly categories of severe weather were tornadoes, perhaps because they are largely unpredictable both in terms of occurrence and location besides being so destructive. Other very deadly weather categories included flooding, extremely dry and hot weather, along with strong wind. The plot below compares the deadliness of severe weather categories both in terms of fatalities and injuries. 

```{r echo=FALSE}

```

```{r echo=FALSE}


  
```


What stood out most in the analysis of the casualties and damages data was incredibly high material cost associated with severe weather, both summatively and by individual event category. I was incredulous (and still am to some degree) with the summaries the analysis produced since the aggregate annual damages sometimes reach into the trillions of dollars.

Fortunately, the injuries and loss of life figures did not seem as inflated as the material losses. While some particular events, such as major hurricanes caused noticeable spikes in the data, the mean casualty rate for most of the generated event categories was around one.

## Citations & Links

[1]: https://en.wikipedia.org/wiki/1993_Storm_of_the_Century

[2]: https://en.wikipedia.org/wiki/Cerro_Grande_Fire